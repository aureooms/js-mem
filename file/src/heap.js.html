<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/heap.js | aureooms/js-memory API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>


  <script src="script/manual.js"></script>
<script data-ice="userScript" src="user/script/0-header.js"></script>
<link data-ice="userStyle" rel="stylesheet" href="user/css/0-style.css">
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/aureooms/js-memory.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>

  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-heap">heap</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-Pool">Pool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-_calloc">_calloc</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-malloc">malloc</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/heap.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">

/**
 * /!\ INCOMPLETE
 * Heap manager backed by a buffer.
 */

export function heap ( Buffer ) {

	/**
	 * The *s* prefix in members and methods stands for size.
	 * The *a* prefix in members and methods stands for address.
	 */

	var Heap = function ( n ) {
		this.buffer = new Buffer( n ) ;
		this.n = 1 ;
		this.slo = 0 ;
		this.shi = 1 ;
		this.alo = 0 ;
		this.ahi = 1 ;
		this.size = new Uint32Array( 1 ) ;
		this.addr = new Uint32Array( 1 ) ;
		this.smap = new Uint32Array( 1 ) ;
		this.amap = new Uint32Array( 1 ) ;
		this.size[0] = n ;
		this.addr[0] = 0 ;
		this.smap[0] = 0 ;
		this.amap[0] = 0 ;
	};

	Heap.prototype.alloc = function ( n ) {

		var i , j ;

		i = this.ssearch( n , this.slo, this.shi);
		this.size[i] -= n;
		this.addr[i] += n;
		j = this.ssearch(n, this.slo, i);
		this.smove(i, j);
		return i;
	};

	Heap.prototype.smove = function(i, j) {
		var tmp, m, n, k;
		n = i - j;
		m = this.shi - this.slo - n;

		if (this.slo &gt; 0 &amp;&amp; m &lt; n) {
			--this.slo;
			for (k = this.slo; k &lt; j; ++k) {
				this.size[k] = this.size[k+1];
				this.smap[k] = this.smap[k+1];
			}
			this.size[j] = this.size[i];
			this.smap[j] = this.smap[i];
			for (k = i; k &lt; this.shi; ++k) {
				this.size[k] = this.size[k+1];
				this.smap[k] = this.smap[k+1];
			}
			--this.shi;
		}
		else {
			tmp = this.size[i];
			for (k = i; k &gt; j; --k) {
				this.size[k] = this.size[k-1];
			}
			this.size[j] = tmp;

			tmp = this.smap[i];
			for (k = i; k &gt; j; --k) {
				this.smap[k] = this.smap[k-1];
			}
			this.smap[j] = tmp;
		}

		this.amap[this.smap[j]] = j;

	};


	Heap.prototype.free = function(i, n) {
		var j, k, tmp, joinleft, joinright;
		j = this.asearch(i, this.alo, this.ahi);

		joinleft = this.addr[j-1] + this.size[this.amap[j-1]] === i;
		joinright = i + n === this.addr[j];

		if (joinleft ^ joinright) {
			if (joinleft) {
				this.size[this.amap[j-1]] += n;
			}
			else {
				this.addr[j] -= n;
			}
		}
		else {
			if (joinleft) {
				this.addr[j-1] = this.addr[j-1];
				this.size[y] = n + this.size[j-1] + this.size[j];
				this.smap[y] = j-1;
				this.amap[j-1] = y;
			}
			else {
				this.addr[j] = i;
				this.size[y] = n;
				this.smap[y] = j;
				this.amap[j] = y;
			}
		}

		for (k = this.ahi; k &gt; j; --k) {
			this.addr[k] = this.addr[k-1];
			this.amap[k] = this.amap[k-1];
		}


	};

}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
