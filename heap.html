<!DOCTYPE html><html lang="en"><head><title>heap</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="heap"><meta name="groc-project-path" content="js/src/heap.js"><meta name="groc-github-url" content="https://github.com/aureooms/js-mem"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/aureooms/js-mem/blob/master/js/src/heap.js">js/src/heap.js</a></div></div><div id="document"><div class="segment"></div><div class="segment"><div class="comments "><div class="wrapper"><p>/!\ INCOMPLETE
Heap manager backed by a buffer.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">var</span> heap = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( Buffer )</span> {</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The <em>s</em> prefix in members and methods stands for size.
The <em>a</em> prefix in members and methods stands for address.</p></div></div><div class="code"><div class="wrapper">	<span class="hljs-keyword">var</span> Heap = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( n )</span> {</span>
		<span class="hljs-keyword">this</span>.buffer = <span class="hljs-keyword">new</span> Buffer( n ) ;
		<span class="hljs-keyword">this</span>.n = <span class="hljs-number">1</span> ;
		<span class="hljs-keyword">this</span>.slo = <span class="hljs-number">0</span> ;
		<span class="hljs-keyword">this</span>.shi = <span class="hljs-number">1</span> ;
		<span class="hljs-keyword">this</span>.alo = <span class="hljs-number">0</span> ;
		<span class="hljs-keyword">this</span>.ahi = <span class="hljs-number">1</span> ;
		<span class="hljs-keyword">this</span>.size = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>( <span class="hljs-number">1</span> ) ;
		<span class="hljs-keyword">this</span>.addr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>( <span class="hljs-number">1</span> ) ;
		<span class="hljs-keyword">this</span>.smap = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>( <span class="hljs-number">1</span> ) ;
		<span class="hljs-keyword">this</span>.amap = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint32Array</span>( <span class="hljs-number">1</span> ) ;
		<span class="hljs-keyword">this</span>.size[<span class="hljs-number">0</span>] = n ;
		<span class="hljs-keyword">this</span>.addr[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span> ;
		<span class="hljs-keyword">this</span>.smap[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span> ;
		<span class="hljs-keyword">this</span>.amap[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span> ;
	};

	Heap.prototype.alloc = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( n )</span> {</span>

		<span class="hljs-keyword">var</span> i , j ;

		i = <span class="hljs-keyword">this</span>.ssearch( n , <span class="hljs-keyword">this</span>.slo, <span class="hljs-keyword">this</span>.shi);
		<span class="hljs-keyword">this</span>.size[i] -= n;
		<span class="hljs-keyword">this</span>.addr[i] += n;
		j = <span class="hljs-keyword">this</span>.ssearch(n, <span class="hljs-keyword">this</span>.slo, i);
		<span class="hljs-keyword">this</span>.smove(i, j);
		<span class="hljs-keyword">return</span> i;
	};

	Heap.prototype.smove = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i, j)</span> {</span>
		<span class="hljs-keyword">var</span> tmp, m, n, k;
		n = i - j;
		m = <span class="hljs-keyword">this</span>.shi - <span class="hljs-keyword">this</span>.slo - n;

		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.slo &gt; <span class="hljs-number">0</span> &amp;&amp; m &lt; n) {
			--<span class="hljs-keyword">this</span>.slo;
			<span class="hljs-keyword">for</span> (k = <span class="hljs-keyword">this</span>.slo; k &lt; j; ++k) {
				<span class="hljs-keyword">this</span>.size[k] = <span class="hljs-keyword">this</span>.size[k+<span class="hljs-number">1</span>];
				<span class="hljs-keyword">this</span>.smap[k] = <span class="hljs-keyword">this</span>.smap[k+<span class="hljs-number">1</span>];
			}
			<span class="hljs-keyword">this</span>.size[j] = <span class="hljs-keyword">this</span>.size[i];
			<span class="hljs-keyword">this</span>.smap[j] = <span class="hljs-keyword">this</span>.smap[i];
			<span class="hljs-keyword">for</span> (k = i; k &lt; <span class="hljs-keyword">this</span>.shi; ++k) {
				<span class="hljs-keyword">this</span>.size[k] = <span class="hljs-keyword">this</span>.size[k+<span class="hljs-number">1</span>];
				<span class="hljs-keyword">this</span>.smap[k] = <span class="hljs-keyword">this</span>.smap[k+<span class="hljs-number">1</span>];
			}
			--<span class="hljs-keyword">this</span>.shi;
		}
		<span class="hljs-keyword">else</span> {
			tmp = <span class="hljs-keyword">this</span>.size[i];
			<span class="hljs-keyword">for</span> (k = i; k &gt; j; --k) {
				<span class="hljs-keyword">this</span>.size[k] = <span class="hljs-keyword">this</span>.size[k-<span class="hljs-number">1</span>];
			}
			<span class="hljs-keyword">this</span>.size[j] = tmp;

			tmp = <span class="hljs-keyword">this</span>.smap[i];
			<span class="hljs-keyword">for</span> (k = i; k &gt; j; --k) {
				<span class="hljs-keyword">this</span>.smap[k] = <span class="hljs-keyword">this</span>.smap[k-<span class="hljs-number">1</span>];
			}
			<span class="hljs-keyword">this</span>.smap[j] = tmp;
		}

		<span class="hljs-keyword">this</span>.amap[<span class="hljs-keyword">this</span>.smap[j]] = j;

	};


	Heap.prototype.free = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i, n)</span> {</span>
		<span class="hljs-keyword">var</span> j, k, tmp, joinleft, joinright;
		j = <span class="hljs-keyword">this</span>.asearch(i, <span class="hljs-keyword">this</span>.alo, <span class="hljs-keyword">this</span>.ahi);

		joinleft = <span class="hljs-keyword">this</span>.addr[j-<span class="hljs-number">1</span>] + <span class="hljs-keyword">this</span>.size[<span class="hljs-keyword">this</span>.amap[j-<span class="hljs-number">1</span>]] === i;
		joinright = i + n === <span class="hljs-keyword">this</span>.addr[j];

		<span class="hljs-keyword">if</span> (joinleft ^ joinright) {
			<span class="hljs-keyword">if</span> (joinleft) {
				<span class="hljs-keyword">this</span>.size[<span class="hljs-keyword">this</span>.amap[j-<span class="hljs-number">1</span>]] += n;
			}
			<span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">this</span>.addr[j] -= n;
			}
		}
		<span class="hljs-keyword">else</span> {
			<span class="hljs-keyword">if</span> (joinleft) {
				<span class="hljs-keyword">this</span>.addr[j-<span class="hljs-number">1</span>] = <span class="hljs-keyword">this</span>.addr[j-<span class="hljs-number">1</span>];
				<span class="hljs-keyword">this</span>.size[y] = n + <span class="hljs-keyword">this</span>.size[j-<span class="hljs-number">1</span>] + <span class="hljs-keyword">this</span>.size[j];
				<span class="hljs-keyword">this</span>.smap[y] = j-<span class="hljs-number">1</span>;
				<span class="hljs-keyword">this</span>.amap[j-<span class="hljs-number">1</span>] = y;
			}
			<span class="hljs-keyword">else</span> {
				<span class="hljs-keyword">this</span>.addr[j] = i;
				<span class="hljs-keyword">this</span>.size[y] = n;
				<span class="hljs-keyword">this</span>.smap[y] = j;
				<span class="hljs-keyword">this</span>.amap[j] = y;
			}
		}

		<span class="hljs-keyword">for</span> (k = <span class="hljs-keyword">this</span>.ahi; k &gt; j; --k) {
			<span class="hljs-keyword">this</span>.addr[k] = <span class="hljs-keyword">this</span>.addr[k-<span class="hljs-number">1</span>];
			<span class="hljs-keyword">this</span>.amap[k] = <span class="hljs-keyword">this</span>.amap[k-<span class="hljs-number">1</span>];
		}


	};


};

exports.heap = heap;</div></div></div></div></body></html>